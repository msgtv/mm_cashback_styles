const startButtonSelector="bc-id-start-button",startButtonTextContent="\uD83E\uDD11\uD83D\uDD0D\uD83D\uDCB5",overlay=document.createElement("div"),form=document.createElement("form");overlay.id="bc-id-overlay",form.id="bc-id-form",window.IntervalNum=0;const priceSelector=".item-money .item-price span",bonusSelector=".item-money .item-bonus span.bonus-amount",discountSelector='span[class*="old-price-discount"][class$="price"]',discountPercentageSelector="div.discount-percentage",rootSelectors=[".catalog-items-list",],showMoreBtnSelectors=[".catalog-items-list__show-more",".cnc-catalog-listing__show-more","button.catalog-listing__show-more",],outOfStockSelector=".catalog-listing__out-of-stock_items",outOfStockSelectors=[".catalog-items-list__out-of-stock-heading"],RewardDicount="DST",RewardCashback="CHK",SortDesc="DSC",SortTotalCost="TTC",whatFind="bc-id-w-f",percentId="bc-id-min-per",howSort="bc-id-sort",pageId="bc-id-max-page",submitBtn="bc-id-smt",hostname="megamarket.ru",itemsCatalogExample="https://megamarket.ru/catalog/",cashBackSortType=`<div id="div-${howSort}">
                            <label for="${howSort}">
                                Сорт-ка:
                            </label>
                            <select id="${howSort}">
                            <option value="TTC" selected>Цена-кэшбэк</option>
                                <option value="DSC">По убыв. %</option>
                            </select>
                            </div>`;function isItemsExists(){return!!getItems().length}function isFormOpen(){return window.bestCashFormOpen}function formIsOpen(){window.bestCashFormOpen=!0}function formIsClose(){window.bestCashFormOpen=!1}function getInput(){if(console.log(`Form is open? Answer: ${window.bestCashFormOpen}`),isFormOpen())return;let e=`<label for="${whatFind}">
                    Что ищем?
                    </label>
                    <select id="${whatFind}">
                    <option value="${RewardDicount}" selected>Скидку</option>
                    <option value="${RewardCashback}">Кэшбэк</option>
                    </select>
                    <label for="${percentId}"">
                    Мин. %:
                    </label>
                    <input type="number" id="${percentId}" name="min-percent" value="" required">`;window.MyBCL?e+=`<p><b>${window.MyBCL.length} шт.</b></p>`:e+=`<label for="${pageId}">Страниц:</label><input type="number" id="${pageId}" name="max-page"">`,e+=`<input id="bc-id-smt" type="submit" value="СТАРТ">`,getHostname()!=hostname?(form.tagName="DIV",e=`<div><h4>Перейдите на <a href="https://megamarket.ru/catalog/">${hostname}</a></h4></div>`):isItemsExists()||window.MyBCL?form.addEventListener("submit",function(e){e.preventDefault();let t=parseInt(document.getElementById(percentId).value),o=document.getElementById(whatFind).value,r=o==RewardCashback?document.getElementById(howSort).value:void 0,n;n=window.MyBCL?0:parseInt(document.getElementById(pageId).value),removeBookmarklet(),start(t,n,o,r),formIsClose()}):(form.tagName="DIV",e=`<div><h4>Товары не обнаружены</h4></div>`),form.innerHTML="",form.insertAdjacentHTML("beforeend",e),addBookmarklet(),overlay.addEventListener("click",removeBookmarklet,{once:!0})}function addBookmarklet(){document.body.insertAdjacentElement("beforeend",overlay),document.body.insertAdjacentElement("beforeend",form),formIsOpen()}function removeBookmarklet(){form.parentNode.removeChild(form),overlay.parentNode.removeChild(overlay),formIsClose(),window.bestCashFormOpen=!1}document.addEventListener("change",function(e){var t=e.target;if(t.id==whatFind){var o=document.getElementById(howSort);if(t.value==RewardCashback)o||document.getElementById(whatFind).insertAdjacentHTML("afterend",cashBackSortType);else if(o){var r=document.getElementById(`div-${howSort}`);r&&r.parentNode.removeChild(r)}}});const itemsSelectors=["div.catalog-item-mobile","div.catalog-item",];function getRoot(){let e;for(let t of rootSelectors)if(e=document.querySelector(t))break;return e}function getMoreBtn(){let e;for(let t of showMoreBtnSelectors)if(e=document.querySelector(t))break;return e}function getPrice(e){return parseInt(e.replace(" ",""))}function getItems(){let e=[];for(let t of itemsSelectors)if((e=document.querySelectorAll(t)).length)break;return Array.from(e)}function isOutOfStockExists(){for(var e of outOfStockSelectors)if(document.querySelectorAll(e).length)return!0;return!1}function removeItemFromPage(e){try{e.parentNode.removeChild(e)}catch{}}function removeItemsFromPage(e){e.forEach(function(e,t){removeItemFromPage(e)})}function removeOutOfStock(){let e=document.querySelector(".catalog-listing__out-of-stock_items");e&&removeItemFromPage(e)}function getItemPriceBonusPercents(e,t){let o;o=t==RewardCashback?".item-money .item-bonus span.bonus-amount":'span[class*="old-price-discount"][class$="price"]';let r=e.querySelector(priceSelector).textContent,n=e.querySelector(o).textContent;return pp=getPrice(r),bp=getPrice(n),ps=t==RewardCashback?Math.round(bp/pp*100):100-Math.round(pp/bp*100),[pp,bp,ps]}function parsing(e,t,o,r){let n=[];for(let a of window.MyBCL)try{var[i,c,s]=getItemPriceBonusPercents(a,o),l=a.cloneNode(!0);if(s>=e){n.push(l);var m=i-c;removeItemFromPage(l.querySelector("div.discount-percentage")),l.dataset.totalCost=m,l.dataset.percents=s;var d=l.querySelector(priceSelector),u=`${s}%`;o==RewardCashback&&(u=`${m} ₽ | `+u),d.insertAdjacentHTML("beforebegin",`<span style="color:red;">${u}</span><br>`)}}catch{continue}t.innerHTML="",n.sort("TTC"==r?sortingByTotalCost:sortingByPercentDesc),n.forEach((e,o)=>t.appendChild(e))}function getDataPercents(e,t){return parseInt(e.dataset[t])}function sortingByPercentDesc(e,t){try{var o=getDataPercents(e,"percents"),r=getDataPercents(t,"percents");if(o>r)return -1;if(o==r)return 0;if(o<r)return 1}catch{}}function sortingByTotalCost(e,t){var o=getDataPercents(e,"totalCost"),r=getDataPercents(t,"totalCost");return o>r?1:o==r?0:o<r?-1:void 0}function delay(){return new Promise(e=>setTimeout(e,3e3))}async function paginateWithCollectItems(e,t=0){let o=getMoreBtn();t+=1;let r;for(;!(r=getItems()).length;)console.log("page loading waiting..."),await delay(1e3);if(removeItemsFromPage(r),window.MyBCL=window.MyBCL.concat(Array.from(r)),e&&t==e||e<1){removeItemFromPage(o);return}if(isOutOfStockExists()){removeOutOfStock(),removeItemFromPage(o);return}return o?(o.click(),await delay(),await paginateWithCollectItems(e,t)):void 0}async function startParsing(e,t,o,r){window.MyBCL||(window.MyBCL=[],await paginateWithCollectItems(t,0));parsing(e,getRoot(),o,r)}function getHostname(){return window.location.hostname}function start(e,t,o,r){e<0&&(e=0),startParsing(e,t,o,r)}
