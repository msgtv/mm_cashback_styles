const overlay=document.createElement("div"),form=document.createElement("form");overlay.id="bc-id-overlay",form.id="bc-id-form",window.IntervalNum=0;const priceSelector=".item-money .item-price span",bonusSelector=".item-money .item-bonus span.bonus-amount",discountSelector='span[class*="old-price-discount"][class$="price"]',discountPercentageSelector="div.discount-percentage",rootSelectors=[".catalog-items-list"],showMoreBtnSelectors=[".catalog-items-list__show-more",".cnc-catalog-listing__show-more","button.catalog-listing__show-more"],outOfStockSelector=".catalog-listing__out-of-stock_items",outOfStockSelectors=[".catalog-items-list__out-of-stock-heading"],RewardDicount="DST",RewardCashback="CHK",SortDesc="DSC",SortTotalCost="TTC",whatFind="bc-id-w-f",percentId="bc-id-min-per",howSort="bc-id-sort",pageId="bc-id-max-page",submitBtn="bc-id-smt",hostname="megamarket.ru",itemsCatalogExample="https://megamarket.ru/catalog/",cashBackSortType=`<div id="div-${howSort}">\n                            <label for="${howSort}">\n                                Сорт-ка:\n                            </label>\n                            <select id="${howSort}">\n                            <option value="${SortTotalCost}" selected>Цена-кэшбэк</option>\n                                <option value="DSC">По убыв. %</option>\n                            </select>\n                            </div>`;function isItemsExists(){return!!getItems().length}function isFormOpen(){return window.bestCashFormOpen}function formIsOpen(){window.bestCashFormOpen=!0}function formIsClose(){window.bestCashFormOpen=!1}function getInput(){if(console.log(`Form is open? Answer: ${window.bestCashFormOpen}`),isFormOpen())return;let e=`<label for="${whatFind}">\n                    Что ищем?\n                    </label>\n                    <select id="${whatFind}">\n                    <option value="DST" selected>Скидку</option>\n                    <option value="${RewardCashback}">Кэшбэк</option>\n                    </select>\n                    <label for="${percentId}"">\n                    Мин. %:\n                    </label>\n                    <input type="number" id="${percentId}" name="min-percent" value="" required">`;window.MyBCL?e+=`<p><b>${window.MyBCL.length} шт.</b></p>`:e+=`<label for="${pageId}">Страниц:</label><input type="number" id="${pageId}" name="max-page"">`,e+=`<input id="${submitBtn}" type="submit" value="СТАРТ">`,getHostname()!=hostname?(form.tagName="DIV",e=`<div><h4>Перейдите на <a href="${itemsCatalogExample}">${hostname}</a></h4></div>`):isItemsExists()||window.MyBCL?form.addEventListener("submit",(function(e){e.preventDefault();const t=parseInt(document.getElementById(percentId).value),o=document.getElementById(whatFind).value,n=o==RewardCashback?document.getElementById(howSort).value:void 0;let r;r=window.MyBCL?0:parseInt(document.getElementById(pageId).value),removeBookmarlet(),start(t,r,o,n),formIsClose()})):(form.tagName="DIV",e="<div><h4>Товары не обнаружены</h4></div>"),form.innerHTML="",form.insertAdjacentHTML("beforeend",e),addBookmarlet(),overlay.addEventListener("click",removeBookmarlet,{once:!0})}function addBookmarklet(){document.body.insertAdjacentElement("beforeend",overlay),document.body.insertAdjacentElement("beforeend",form),formIsOpen()}function removeBookmarlet(){form.parentNode.removeChild(form),overlay.parentNode.removeChild(overlay),formIsClose(),window.bestCashFormOpen=!1}document.addEventListener("change",(function(e){var t=e.target;if(t.id==whatFind){var o=document.getElementById(howSort);if(t.value==RewardCashback)o||document.getElementById(whatFind).insertAdjacentHTML("afterend",cashBackSortType);else if(o){var n=document.getElementById(`div-${howSort}`);n&&n.parentNode.removeChild(n)}}}));const itemsSelectors=["div.catalog-item-mobile","div.catalog-item"];function getRoot(){let e;for(let t of rootSelectors)if(e=document.querySelector(t),e)break;return e}function getMoreBtn(){let e;for(let t of showMoreBtnSelectors)if(e=document.querySelector(t),e)break;return e}function getPrice(e){return parseInt(e.replace(" ",""))}function getItems(){let e=[];for(let t of itemsSelectors)if(e=document.querySelectorAll(t),e.length)break;return Array.from(e)}function isOutOfStockExists(){for(var e of outOfStockSelectors)if(document.querySelectorAll(e).length)return!0;return!1}function removeItemFromPage(e){try{e.parentNode.removeChild(e)}catch{}}function removeItemsFromPage(e){e.forEach((function(e,t){removeItemFromPage(e)}))}function removeOutOfStock(){let e=document.querySelector(outOfStockSelector);e&&removeItemFromPage(e)}function getItemPriceBonusPercents(e,t){let o;o=t==RewardCashback?bonusSelector:discountSelector;let n=e.querySelector(priceSelector).textContent,r=e.querySelector(o).textContent;return pp=getPrice(n),bp=getPrice(r),ps=t==RewardCashback?Math.round(bp/pp*100):100-Math.round(pp/bp*100),[pp,bp,ps]}function parsing(e,t,o,n){let r=[];for(let t of window.MyBCL)try{var[a,i,c]=getItemPriceBonusPercents(t,o),s=t.cloneNode(!0);if(c>=e){r.push(s);var l=a-i;removeItemFromPage(s.querySelector(discountPercentageSelector)),s.dataset.totalCost=l,s.dataset.percents=c;var m=s.querySelector(priceSelector),d=`${c}%`;o==RewardCashback&&(d=`${l} ₽ | `+d),m.insertAdjacentHTML("beforebegin",`<span style="color:red;">${d}</span><br>`)}}catch{continue}t.innerHTML="";var u=n==SortTotalCost?sortingByTotalCost:sortingByPercentDesc;r.sort(u),r.forEach(((e,o)=>t.appendChild(e)))}function getDataPercents(e,t){return parseInt(e.dataset[t])}function sortingByPercentDesc(e,t){try{var o=getDataPercents(e,"percents"),n=getDataPercents(t,"percents");if(o>n)return-1;if(o==n)return 0;if(o<n)return 1}catch{}}function sortingByTotalCost(e,t){var o=getDataPercents(e,"totalCost"),n=getDataPercents(t,"totalCost");return o>n?1:o==n?0:o<n?-1:void 0}function delay(){return new Promise((e=>setTimeout(e,3e3)))}async function paginateWithCollectItems(e,t=0){let o,n=getMoreBtn();for(t+=1;o=getItems(),!o.length;)console.log("page loading waiting..."),await delay(1e3);if(removeItemsFromPage(o),window.MyBCL=window.MyBCL.concat(Array.from(o)),!(e&&t==e||e<1))return isOutOfStockExists()?(removeOutOfStock(),void removeItemFromPage(n)):n?(n.click(),await delay(),await paginateWithCollectItems(e,t)):void 0;removeItemFromPage(n)}async function startParsing(e,t,o,n){window.MyBCL||(window.MyBCL=new Array,await paginateWithCollectItems(t,0)),parsing(e,getRoot(),o,n)}function getHostname(){return window.location.hostname}function start(e,t,o,n){e<0&&(e=0),startParsing(e,t,o,n)}
